name: Auto Tag and Release

on:
    push:
        branches:
            - main
        paths-ignore:
            - "*.md"
            - "docs/**"

jobs:
    tag:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get last tag
              id: last_tag
              run: |
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                  echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
                  echo "Last tag: $LAST_TAG"

            - name: Calculate next version
              id: version
              run: |
                  LAST_TAG_FULL="${{ steps.last_tag.outputs.last_tag }}"
                  LAST_TAG=${LAST_TAG_FULL#v}

                  IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_TAG"

                  COMMITS=$(git log ${LAST_TAG_FULL}..HEAD --pretty=format:"%s" 2>/dev/null | grep -v "^chore(release):" || true)

                  if [ -z "$COMMITS" ]; then
                    echo "No new commits since last tag, skipping"
                    echo "skip=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  INCREMENT="patch"
                  if echo "$COMMITS" | grep -qiE "(BREAKING CHANGE|!:)"; then
                    INCREMENT="major"
                  elif echo "$COMMITS" | grep -qiE "^(feat|feature):"; then
                    INCREMENT="minor"
                  fi

                  if [ "$INCREMENT" = "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                  elif [ "$INCREMENT" = "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                  else
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION"

            - name: Check if tag exists
              id: check_tag
              run: |
                  if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Configure git
              if: steps.check_tag.outputs.exists == 'false' && steps.version.outputs.skip != 'true'
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

            - name: Create tag and release
              if: steps.check_tag.outputs.exists == 'false' && steps.version.outputs.skip != 'true'
              run: |
                  git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
                  git push origin "${{ steps.version.outputs.version }}"

                  gh release create "${{ steps.version.outputs.version }}" \
                    --title "Release ${{ steps.version.outputs.version }}" \
                    --notes "Automated release based on conventional commits"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
